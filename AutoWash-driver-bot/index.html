
<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoWash Driver Bot - To'liq Simulator</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #0f1419;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .phone-container {
            width: 100%;
            max-width: 400px;
            height: 800px;
            background: #ffffff;
            border-radius: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .phone-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 50px 20px 20px;
            color: white;
            text-align: center;
            position: relative;
        }

        .phone-notch {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 25px;
            background: #000;
            border-radius: 0 0 20px 20px;
        }

        .bot-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .bot-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #e5ddd5;
            background-image: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><rect fill="%23f0f0f0" width="100" height="100" opacity="0.1"/></svg>');
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.bot {
            justify-content: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
        }

        .message.bot .message-bubble {
            background: white;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .message.user .message-bubble {
            background: #dcf8c6;
            border-bottom-right-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .message-time {
            font-size: 11px;
            color: #667;
            margin-top: 4px;
            text-align: right;
        }

        .keyboard {
            background: white;
            padding: 10px;
            border-top: 1px solid #ddd;
        }

        .keyboard-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .keyboard-button {
            flex: 1;
            padding: 12px;
            background: white;
            border: 1px solid #667eea;
            color: #667eea;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .keyboard-button:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .keyboard-button.primary {
            background: #667eea;
            color: white;
            border: none;
        }

        .keyboard-button.primary:hover {
            background: #5568d3;
        }

        .inline-keyboard {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .inline-button {
            padding: 10px 16px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            text-align: center;
        }

        .inline-button:hover {
            background: #f0f0f0;
            border-color: #667eea;
        }

        .map-container {
            width: 100%;
            height: 200px;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 10px;
        }

        .workshop-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-top: 10px;
            border: 1px solid #e0e0e0;
        }

        .workshop-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .workshop-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .workshop-info {
            flex: 1;
        }

        .workshop-name {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .workshop-rating {
            color: #ffa500;
            font-size: 14px;
        }

        .workshop-details {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .workshop-details div {
            margin-bottom: 4px;
        }

        .service-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            padding: 15px;
            margin-top: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .service-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .service-name {
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 8px;
        }

        .service-details {
            font-size: 13px;
            color: #555;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .qr-code {
            width: 200px;
            height: 200px;
            margin: 20px auto;
            background: white;
            border: 2px solid #667eea;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .qr-code canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .booking-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 10px;
        }

        .booking-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .booking-item:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 18px;
        }

        .queue-visual {
            background: white;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre;
            text-align: center;
            line-height: 1.6;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-confirmed { background: #d1ecf1; color: #0c5460; }
        .status-washing { background: #d4edda; color: #155724; }
        .status-completed { background: #d4edda; color: #155724; }

        .loyalty-card {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 10px;
        }

        .loyalty-points {
            font-size: 36px;
            font-weight: 700;
            margin: 10px 0;
        }

        .loyalty-tier {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .rating-stars {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }

        .star {
            font-size: 36px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .star:hover {
            transform: scale(1.2);
        }

        .input-container {
            background: white;
            padding: 15px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }

        .input-field {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
        }

        .send-button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
        }

        .typing-indicator {
            display: none;
            padding: 10px 15px;
            background: white;
            border-radius: 18px;
            width: fit-content;
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .hidden { display: none !important; }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: #667eea;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="phone-container">
        <div class="phone-notch"></div>
        <div class="phone-header">
            <div class="bot-title">üöø AutoWash Bot</div>
            <div class="bot-subtitle">Haydovchilar uchun</div>
        </div>

        <div class="chat-container" id="chatContainer">
            <!-- Messages will be added here -->
        </div>

        <div class="typing-indicator" id="typingIndicator">
            <span></span>
            <span></span>
            <span></span>
        </div>

        <div class="keyboard" id="keyboard">
            <!-- Keyboard will be added here dynamically -->
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        // State Management
        const state = {
            user: null,
            currentStep: 'start',
            selectedWorkshop: null,
            selectedService: null,
            booking: null,
            favorites: [],
            history: [],
            loyaltyPoints: 0,
            location: null
        };

        // Mock Data
        const workshops = [
            {
                id: 1,
                name: 'Crystal Wash',
                rating: 4.8,
                reviews: 234,
                distance: 0.5,
                price_min: 30000,
                price_max: 150000,
                queue: 2,
                address: 'Yunusobod tumani, Amir Temur ko\'chasi 123',
                latitude: 41.3275,
                longitude: 69.2401,
                phone: '+998901234567'
            },
            {
                id: 2,
                name: 'Premium Auto Wash',
                rating: 4.9,
                reviews: 456,
                distance: 1.2,
                price_min: 50000,
                price_max: 200000,
                queue: 0,
                address: 'Mirzo Ulug\'bek tumani, Buyuk Ipak Yo\'li 45',
                latitude: 41.3150,
                longitude: 69.2800,
                phone: '+998902345678'
            },
            {
                id: 3,
                name: 'Express Wash',
                rating: 4.6,
                reviews: 187,
                distance: 2.3,
                price_min: 25000,
                price_max: 120000,
                queue: 5,
                address: 'Chilonzor tumani, Katartal ko\'chasi 78',
                latitude: 41.2850,
                longitude: 69.2100,
                phone: '+998903456789'
            }
        ];

        const services = {
            1: [
                { id: 1, name: "Oddiy yuvish", category: "exterior", price: 30000, duration: 15 },
                { id: 2, name: "Kompleks yuvish", category: "exterior", price: 50000, duration: 20 },
                { id: 3, name: "Ichki tozalash", category: "interior", price: 40000, duration: 30 },
                { id: 4, name: "Premium tozalash", category: "interior", price: 70000, duration: 40 },
                { id: 5, name: "Polirovka", category: "detailing", price: 150000, duration: 120 },
                { id: 6, name: "VIP paket", category: "full", price: 200000, duration: 90 }
            ],
            2: [
                { id: 7, name: "Standart yuvish", category: "exterior", price: 50000, duration: 20 },
                { id: 8, name: "Premium yuvish", category: "exterior", price: 80000, duration: 25 },
                { id: 9, name: "Salon tozalash", category: "interior", price: 60000, duration: 35 },
                { id: 10, name: "Detailing", category: "detailing", price: 180000, duration: 150 }
            ],
            3: [
                { id: 11, name: "Tez yuvish", category: "exterior", price: 25000, duration: 10 },
                { id: 12, name: "Oddiy yuvish", category: "exterior", price: 35000, duration: 15 },
                { id: 13, name: "Ichki yuvish", category: "interior", price: 45000, duration: 30 }
            ]
        };

        // Initialize
        let map = null;
        
        function init() {
            loadFromStorage();
            showMessage('bot', 'Assalomu alaykum! üëã\n\nAutoWash ga xush kelibsiz!\n\nMen sizga eng yaqin va eng yaxshi avtomoykalrni topishda yordam beraman.\n\nBoshlash uchun /start bosing.');
            showKeyboard([
                [{ text: '/start', action: 'start' }]
            ]);
        }

        // Message Handling
        function showMessage(type, text, options = {}) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.innerHTML = text.replace(/\n/g, '<br>');

            if (options.inline) {
                const inlineKeyboard = createInlineKeyboard(options.inline);
                bubble.appendChild(inlineKeyboard);
            }

            const time = document.createElement('div');
            time.className = 'message-time';
            time.textContent = new Date().toLocaleTimeString('uz-UZ', { hour: '2-digit', minute: '2-digit' });
            bubble.appendChild(time);

            messageDiv.appendChild(bubble);
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function showTyping() {
            document.getElementById('typingIndicator').style.display = 'block';
            document.getElementById('chatContainer').scrollTop = document.getElementById('chatContainer').scrollHeight;
        }

        function hideTyping() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        async function botReply(text, options = {}) {
            showTyping();
            await sleep(1000);
            hideTyping();
            showMessage('bot', text, options);
        }

        // Keyboard Handling
        function showKeyboard(buttons) {
            const keyboard = document.getElementById('keyboard');
            keyboard.innerHTML = '';

            buttons.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'keyboard-row';

                row.forEach(btn => {
                    const button = document.createElement('button');
                    button.className = `keyboard-button ${btn.primary ? 'primary' : ''}`;
                    button.textContent = btn.text;
                    button.onclick = () => handleAction(btn.action, btn.data);
                    rowDiv.appendChild(button);
                });

                keyboard.appendChild(rowDiv);
            });
        }

        function createInlineKeyboard(buttons) {
            const container = document.createElement('div');
            container.className = 'inline-keyboard';

            buttons.forEach(row => {
                row.forEach(btn => {
                    const button = document.createElement('div');
                    button.className = 'inline-button';
                    button.textContent = btn.text;
                    button.onclick = () => handleAction(btn.action, btn.data);
                    container.appendChild(button);
                });
            });

            return container;
        }

        // Action Handlers
        async function handleAction(action, data) {
            console.log('Action:', action, data);

            switch(action) {
                case 'start':
                    await handleStart();
                    break;
                case 'register':
                    await handleRegister();
                    break;
                case 'search':
                    await handleSearch();
                    break;
                case 'view_workshop':
                    await viewWorkshop(data);
                    break;
                case 'book_workshop':
                    await startBooking(data);
                    break;
                case 'select_service':
                    await selectService(data);
                    break;
                case 'confirm_booking':
                    await confirmBooking();
                    break;
                case 'my_bookings':
                    await showMyBookings();
                    break;
                case 'queue_status':
                    await showQueueStatus(data);
                    break;
                case 'loyalty':
                    await showLoyalty();
                    break;
                case 'favorites':
                    await showFavorites();
                    break;
                case 'add_favorite':
                    await addFavorite(data);
                    break;
                case 'history':
                    await showHistory();
                    break;
                case 'rate_booking':
                    await rateBooking(data);
                    break;
                case 'submit_rating':
                    await submitRating(data);
                    break;
                case 'profile':
                    await showProfile();
                    break;
                case 'main_menu':
                    await showMainMenu();
                    break;
            }
        }

        async function handleStart() {
            if (!state.user) {
                showMessage('user', '/start');
                await botReply(
                    'Keling, tanishaylik! Telefon raqamingizni ulashing:',
                    {
                        inline: [[
                            { text: 'üì± Telefon raqamni ulashish', action: 'register' }
                        ]]
                    }
                );
            } else {
                showMessage('user', '/start');
                await showMainMenu();
            }
        }

        async function handleRegister() {
            showMessage('user', 'üì± Telefon raqamni ulashish');
            
            // Simulate phone number
            const phone = '+998901234567';
            state.user = {
                phone: phone,
                name: 'Foydalanuvchi',
                car_brand: 'Chevrolet',
                car_model: 'Nexia',
                car_color: 'Oq',
                car_number: '01 A 777 AA',
                registered_at: new Date()
            };

            state.loyaltyPoints = 500; // Welcome bonus

            await botReply(
                `‚úÖ Muvaffaqiyatli ro'yxatdan o'tdingiz!\n\n` +
                `üöó Avtomobil:\n` +
                `   ${state.user.car_brand} ${state.user.car_model}\n` +
                `   ${state.user.car_color} rang\n` +
                `   ${state.user.car_number}\n\n` +
                `üéÅ Bonus: 500 ball (50,000 so'm)\n` +
                `   Birinchi yuvishda ishlatishingiz mumkin!`
            );

            saveToStorage();
            await showMainMenu();
        }

        async function showMainMenu() {
            await botReply(
                `üè† Asosiy menyu\n\n` +
                `${state.user.name}, quyidagi xizmatlardan birini tanlang:`
            );

            showKeyboard([
                [
                    { text: 'üîç Qidirish', action: 'search' },
                    { text: 'üìã Buyurtmalar', action: 'my_bookings' }
                ],
                [
                    { text: '‚ù§Ô∏è Sevimlilar', action: 'favorites' },
                    { text: 'üéÅ Loyalty', action: 'loyalty' }
                ],
                [
                    { text: 'üìú Tarix', action: 'history' },
                    { text: 'üë§ Profil', action: 'profile' }
                ]
            ]);
        }

        async function handleSearch() {
            showMessage('user', 'üîç Qidirish');
            await botReply('üîç Yaqin atrofdagi avtomoykalrni qidirish...');

            // Simulate getting location
            state.location = { lat: 41.3111, lng: 69.2797 };

            await sleep(1000);

            await botReply(`üìç Topildi: ${workshops.length} ta avtomoyka\n\nTanlang:`);

            workshops.forEach(workshop => {
                const card = `
                    <div class="workshop-card">
                        <div class="workshop-header">
                            <div class="workshop-icon">üöø</div>
                            <div class="workshop-info">
                                <div class="workshop-name">${workshop.name}</div>
                                <div class="workshop-rating">‚≠ê ${workshop.rating} (${workshop.reviews} sharh)</div>
                            </div>
                        </div>
                        <div class="workshop-details">
                            <div>üìè ${workshop.distance} km</div>
                            <div>üí∞ ${formatPrice(workshop.price_min)} - ${formatPrice(workshop.price_max)} so'm</div>
                            <div>üë• Navbat: ${workshop.queue} ta</div>
                            <div>üìç ${workshop.address}</div>
                        </div>
                    </div>
                `;
                
                showMessage('bot', card, {
                    inline: [
                        [
                            { text: 'üìã Ko\'rish', action: 'view_workshop', data: workshop.id },
                            { text: 'üìÖ Band qilish', action: 'book_workshop', data: workshop.id }
                        ],
                        [
                            { text: '‚ù§Ô∏è Sevimlilar', action: 'add_favorite', data: workshop.id }
                        ]
                    ]
                });
            });
        }

        async function viewWorkshop(workshopId) {
            const workshop = workshops.find(w => w.id === workshopId);
            showMessage('user', `üìã Ko'rish: ${workshop.name}`);

            // Show map
            const mapHtml = `<div class="map-container" id="map-${workshopId}"></div>`;
            showMessage('bot', `üó∫Ô∏è Joylashuv:\n${mapHtml}`);

            setTimeout(() => {
                const mapDiv = document.getElementById(`map-${workshopId}`);
                if (mapDiv && typeof L !== 'undefined') {
                    const workshopMap = L.map(mapDiv).setView([workshop.latitude, workshop.longitude], 15);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(workshopMap);
                    L.marker([workshop.latitude, workshop.longitude])
                        .addTo(workshopMap)
                        .bindPopup(workshop.name);
                }
            }, 100);

            await botReply(
                `üìû Telefon: ${workshop.phone}\n` +
                `‚è∞ Ish vaqti: 09:00 - 21:00\n` +
                `üè¢ Yuvish joylari: 3 ta`,
                {
                    inline: [[
                        { text: 'üìÖ Band qilish', action: 'book_workshop', data: workshopId }
                    ]]
                }
            );
        }

        async function startBooking(workshopId) {
            const workshop = workshops.find(w => w.id === workshopId);
            state.selectedWorkshop = workshop;
            
            showMessage('user', `üìÖ Band qilish: ${workshop.name}`);
            await botReply('üîß Xizmat turini tanlang:');

            const workshopServices = services[workshopId] || [];
            
            // Group by category
            const categories = {
                exterior: { emoji: 'üöø', name: 'TASHQI YUVISH', services: [] },
                interior: { emoji: 'üßΩ', name: 'ICHKI TOZALASH', services: [] },
                detailing: { emoji: '‚ú®', name: 'DETAILING', services: [] },
                full: { emoji: 'üíé', name: 'TO\'LIQ PAKET', services: [] }
            };

            workshopServices.forEach(service => {
                if (categories[service.category]) {
                    categories[service.category].services.push(service);
                }
            });

            Object.values(categories).forEach(cat => {
                if (cat.services.length > 0) {
                    let message = `${cat.emoji} **${cat.name}**\n\n`;
                    const buttons = [];

                    cat.services.forEach(service => {
                        const serviceCard = `
                            <div class="service-card" onclick="handleAction('select_service', ${service.id})">
                                <div class="service-name">${service.name}</div>
                                <div class="service-details">
                                    <span>‚è±Ô∏è ${service.duration} daqiqa</span>
                                    <span>üí∞ ${formatPrice(service.price)} so'm</span>
                                </div>
                            </div>
                        `;
                        message += serviceCard;
                    });

                    showMessage('bot', message);
                }
            });
        }

        async function selectService(serviceId) {
            const workshopServices = services[state.selectedWorkshop.id] || [];
            const service = workshopServices.find(s => s.id === serviceId);
            state.selectedService = service;

            showMessage('user', `${service.name} tanlandi`);

            await botReply(
                `‚è∞ Qachon keling?\n\nVaqtni tanlang:`,
                {
                    inline: [
                        [{ text: 'üî• Hozir kelib turaman', action: 'confirm_booking', data: 'instant' }],
                        [{ text: '‚è∞ Vaqt tanlash (15:00)', action: 'confirm_booking', data: 'scheduled' }]
                    ]
                }
            );
        }

        async function confirmBooking() {
            showMessage('user', '‚úÖ Hozir kelib turaman');

            const booking = {
                id: Date.now(),
                number: `WH-${String(Date.now()).slice(-5)}`,
                workshop: state.selectedWorkshop,
                service: state.selectedService,
                position: state.selectedWorkshop.queue + 1,
                estimatedWait: (state.selectedWorkshop.queue + 1) * 20,
                status: 'in_queue',
                price: state.selectedService.price,
                discount: Math.min(state.loyaltyPoints * 100, state.selectedService.price * 0.3),
                created_at: new Date()
            };

            booking.finalPrice = booking.price - booking.discount;
            state.booking = booking;

            // Award loyalty points
            const earnedPoints = Math.floor(booking.finalPrice / 10000) * 10;
            state.loyaltyPoints += earnedPoints;

            // Generate QR
            const qrHtml = `<div class="qr-code" id="qr-${booking.id}"></div>`;

            await botReply(`‚úÖ Navbat olindi!\n${qrHtml}`);

            setTimeout(() => {
                const qrDiv = document.getElementById(`qr-${booking.id}`);
                if (qrDiv && typeof QRCode !== 'undefined') {
                    new QRCode(qrDiv, {
                        text: JSON.stringify({ booking: booking.number, id: booking.id }),
                        width: 160,
                        height: 160
                    });
                }
            }, 100);

            const summaryHtml = `
                <div class="booking-summary">
                    <div class="booking-item">
                        <span>üé´ Buyurtma:</span>
                        <span>${booking.number}</span>
                    </div>
                    <div class="booking-item">
                        <span>üìç Avtomoyka:</span>
                        <span>${booking.workshop.name}</span>
                    </div>
                    <div class="booking-item">
                        <span>üöø Xizmat:</span>
                        <span>${booking.service.name}</span>
                    </div>
                    <div class="booking-item">
                        <span>üí∞ Narx:</span>
                        <span>${formatPrice(booking.price)} so'm</span>
                    </div>
                    ${booking.discount > 0 ? `
                    <div class="booking-item">
                        <span>üéÅ Chegirma:</span>
                        <span>-${formatPrice(booking.discount)} so'm</span>
                    </div>
                    ` : ''}
                    <div class="booking-item">
                        <span>‚úÖ Jami:</span>
                        <span>${formatPrice(booking.finalPrice)} so'm</span>
                    </div>
                </div>
            `;

            showMessage('bot', summaryHtml);

            const queueHtml = `
                <div class="queue-visual">
üìä NAVBAT HOLATI

üöó ‚Üí üöô ‚Üí [SIZ] ‚Üí üèÅ

‚è±Ô∏è Taxminiy kutish:
   ${booking.estimatedWait} daqiqa

üìç Pozitsiya: #${booking.position}
                </div>
            `;

            showMessage('bot', queueHtml, {
                inline: [
                    [{ text: 'üìä Jonli navbat', action: 'queue_status', data: booking.id }],
                    [{ text: 'üè† Asosiy menyu', action: 'main_menu' }]
                ]
            });

            // Add to history
            state.history.push(booking);
            saveToStorage();

            // Simulate queue progression
            setTimeout(() => simulateQueueProgress(booking.id), 30000);
        }

        function simulateQueueProgress(bookingId) {
            const booking = state.history.find(b => b.id === bookingId);
            if (!booking) return;

            if (booking.status === 'in_queue') {
                booking.status = 'washing';
                showMessage('bot', 
                    `üöø Yuvish boshlandi!\n\n` +
                    `üé´ ${booking.number}\n` +
                    `‚è±Ô∏è Taxminiy vaqt: ${booking.service.duration} daqiqa`
                );
                setTimeout(() => simulateCompletion(bookingId), 60000);
            }
        }

        function simulateCompletion(bookingId) {
            const booking = state.history.find(b => b.id === bookingId);
            if (!booking) return;

            booking.status = 'completed';
            booking.completed_at = new Date();

            showMessage('bot',
                `‚úÖ Mashinangiz tayyor!\n\n` +
                `üé´ ${booking.number}\n` +
                `üí∞ To'lov: ${formatPrice(booking.finalPrice)} so'm\n` +
                `üéÅ Ball olindi: +${Math.floor(booking.finalPrice / 10000) * 10}`,
                {
                    inline: [
                        [
                            { text: 'üí≥ Click', action: 'payment', data: { type: 'click', id: bookingId } },
                            { text: 'üí≥ Payme', action: 'payment', data: { type: 'payme', id: bookingId } }
                        ],
                        [{ text: 'üíµ Naqd to\'landi', action: 'payment', data: { type: 'cash', id: bookingId } }]
                    ]
                }
            );

            setTimeout(() => {
                showMessage('bot',
                    `‚≠ê Xizmatni baholang:\n\n` +
                    `${booking.workshop.name}`,
                    {
                        inline: [
                            [
                                { text: '‚≠ê', action: 'submit_rating', data: { id: bookingId, rating: 1 } },
                                { text: '‚≠ê‚≠ê', action: 'submit_rating', data: { id: bookingId, rating: 2 } },
                                { text: '‚≠ê‚≠ê‚≠ê', action: 'submit_rating', data: { id: bookingId, rating: 3 } }
                            ],
                            [
                                { text: '‚≠ê‚≠ê‚≠ê‚≠ê', action: 'submit_rating', data: { id: bookingId, rating: 4 } },
                                { text: '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê', action: 'submit_rating', data: { id: bookingId, rating: 5 } }
                            ]
                        ]
                    }
                );
            }, 5000);
        }

        async function showQueueStatus(bookingId) {
            const booking = state.history.find(b => b.id === bookingId);
            showMessage('user', 'üìä Jonli navbat');

            const statusEmoji = {
                'in_queue': '‚è≥',
                'washing': 'üöø',
                'completed': '‚úÖ'
            };

            const queueHtml = `
                <div class="queue-visual">
${statusEmoji[booking.status]} NAVBAT HOLATI

üé´ ${booking.number}
üìç ${booking.workshop.name}

${booking.status === 'in_queue' ? `
‚è≥ Navbatda: ${booking.position} ta oldingizda
‚è±Ô∏è Kutish: ~${booking.estimatedWait} daqiqa
` : booking.status === 'washing' ? `
üöø Yuvish jarayonida
‚è±Ô∏è Qolgan vaqt: ~${booking.service.duration} daqiqa
` : `
‚úÖ Tayyor!
üí∞ To'lov: ${formatPrice(booking.finalPrice)} so'm
`}

üîÑ Yangilandi: ${new Date().toLocaleTimeString('uz-UZ')}
                </div>
            `;

            showMessage('bot', queueHtml, {
                inline: [
                    [{ text: 'üîÑ Yangilash', action: 'queue_status', data: bookingId }],
                    [{ text: 'üè† Asosiy menyu', action: 'main_menu' }]
                ]
            });
        }

        async function showMyBookings() {
            showMessage('user', 'üìã Buyurtmalar');

            if (state.history.length === 0) {
                await botReply('üìã Buyurtmalar yo\'q\n\nHali birorta buyurtma yaratilmagan.');
                return;
            }

            await botReply(`üìã Sizning buyurtmalaringiz: ${state.history.length} ta`);

            state.history.slice().reverse().forEach(booking => {
                const statusEmoji = {
                    'in_queue': '‚è≥',
                    'washing': 'üöø',
                    'completed': '‚úÖ'
                };

                const statusText = {
                    'in_queue': 'Navbatda',
                    'washing': 'Yuvish jarayonida',
                    'completed': 'Bajarilgan'
                };

                const card = `
                    <div class="workshop-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong>${statusEmoji[booking.status]} ${booking.number}</strong>
                            <span class="status-badge status-${booking.status}">${statusText[booking.status]}</span>
                        </div>
                        <div class="workshop-details">
                            <div>üè¢ ${booking.workshop.name}</div>
                            <div>üöø ${booking.service.name}</div>
                            <div>üí∞ ${formatPrice(booking.finalPrice)} so'm</div>
                            <div>üìÖ ${new Date(booking.created_at).toLocaleDateString('uz-UZ')}</div>
                        </div>
                    </div>
                `;

                showMessage('bot', card, {
                    inline: booking.status !== 'completed' ? [
                        [{ text: 'üìä Navbat holati', action: 'queue_status', data: booking.id }]
                    ] : []
                });
            });
        }

        async function showLoyalty() {
            showMessage('user', 'üéÅ Loyalty');

            const tier = getLoyaltyTier(state.loyaltyPoints);

            const loyaltyHtml = `
                <div class="loyalty-card">
                    <div class="loyalty-tier">${tier.emoji} ${tier.name}</div>
                    <div class="loyalty-points">${state.loyaltyPoints}</div>
                    <div style="font-size: 14px;">ball</div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3);">
                        üí∞ Qiymati: ${formatPrice(state.loyaltyPoints * 100)} so'm
                    </div>
                    <div style="margin-top: 10px; font-size: 13px;">
                        ${tier.discount > 0 ? `üéÅ Chegirma: ${tier.discount}%` : ''}
                    </div>
                </div>
            `;

            showMessage('bot', loyaltyHtml);

            await botReply(
                `üìä Statistika:\n\n` +
                `‚úÖ Jami yuvishlar: ${state.history.length}\n` +
                `üí∞ Jami sarflangan: ${formatPrice(state.history.reduce((sum, b) => sum + b.finalPrice, 0))} so'm\n\n` +
                `Keyingi daraja: ${tier.next ? `${tier.next.name} (${tier.next.min} ball)` : 'Maksimal daraja!'}`
            );
        }

        function getLoyaltyTier(points) {
            const tiers = [
                { min: 0, max: 499, name: 'Bronze', emoji: 'ü•â', discount: 0, next: null },
                { min: 500, max: 999, name: 'Silver', emoji: 'ü•à', discount: 5, next: null },
                { min: 1000, max: 2499, name: 'Gold', emoji: 'ü•á', discount: 10, next: null },
                { min: 2500, max: Infinity, name: 'Platinum', emoji: 'üíé', discount: 15, next: null }
            ];

            // Set next tier
            for (let i = 0; i < tiers.length - 1; i++) {
                tiers[i].next = tiers[i + 1];
            }

            for (const tier of tiers) {
                if (points >= tier.min && points <= tier.max) {
                    return tier;
                }
            }
            return tiers[0];
        }

        async function showFavorites() {
            showMessage('user', '‚ù§Ô∏è Sevimlilar');

            if (state.favorites.length === 0) {
                await botReply('‚ù§Ô∏è Sevimlilar ro\'yxati bo\'sh\n\nAvtomoykalarni qo\'shing!');
                return;
            }

            await botReply(`‚ù§Ô∏è Sevimlilar: ${state.favorites.length} ta`);

            state.favorites.forEach(workshopId => {
                const workshop = workshops.find(w => w.id === workshopId);
                if (workshop) {
                    const card = `
                        <div class="workshop-card">
                            <div class="workshop-header">
                                <div class="workshop-icon">üöø</div>
                                <div class="workshop-info">
                                    <div class="workshop-name">${workshop.name}</div>
                                    <div class="workshop-rating">‚≠ê ${workshop.rating}</div>
                                </div>
                            </div>
                        </div>
                    `;

                    showMessage('bot', card, {
                        inline: [[
                            { text: 'üìÖ Band qilish', action: 'book_workshop', data: workshop.id }
                        ]]
                    });
                }
            });
        }

        async function addFavorite(workshopId) {
            if (!state.favorites.includes(workshopId)) {
                state.favorites.push(workshopId);
                saveToStorage();
                showMessage('user', '‚ù§Ô∏è Sevimlilar');
                await botReply('‚úÖ Sevimlilarga qo\'shildi!');
            }
        }

        async function showHistory() {
            showMessage('user', 'üìú Tarix');
            
            const completed = state.history.filter(b => b.status === 'completed');

            if (completed.length === 0) {
                await botReply('üìú Tarix bo\'sh\n\nHali bajarilgan buyurtmalar yo\'q.');
                return;
            }

            await botReply(`üìú Bajarilgan: ${completed.length} ta`);

            completed.slice().reverse().forEach(booking => {
                const card = `
                    <div class="workshop-card">
                        <strong>üé´ ${booking.number}</strong>
                        <div class="workshop-details" style="margin-top: 10px;">
                            <div>üè¢ ${booking.workshop.name}</div>
                            <div>üöø ${booking.service.name}</div>
                            <div>üí∞ ${formatPrice(booking.finalPrice)} so'm</div>
                            <div>üìÖ ${new Date(booking.created_at).toLocaleDateString('uz-UZ')}</div>
                            ${booking.rating ? `<div>‚≠ê Reyting: ${booking.rating}/5</div>` : ''}
                        </div>
                    </div>
                `;

                showMessage('bot', card);
            });
        }

        async function submitRating(data) {
            const booking = state.history.find(b => b.id === data.id);
            booking.rating = data.rating;
            saveToStorage();

            showMessage('user', `‚≠ê ${data.rating} yulduz`);
            await botReply(
                `‚úÖ Rahmat!\n\n` +
                `Sizning fikringiz biz uchun muhim. ‚ù§Ô∏è`
            );
        }

        async function showProfile() {
            showMessage('user', 'üë§ Profil');

            const profileHtml = `
                <div class="workshop-card">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üë§</div>
                        <div style="font-size: 20px; font-weight: 700;">${state.user.name}</div>
                        <div style="color: #666; margin-top: 5px;">${state.user.phone}</div>
                    </div>
                    <div class="workshop-details">
                        <div><strong>üöó Avtomobil:</strong></div>
                        <div>   ${state.user.car_brand} ${state.user.car_model}</div>
                        <div>   ${state.user.car_color} rang</div>
                        <div>   ${state.user.car_number}</div>
                        <div style="margin-top: 10px;"><strong>üìä Statistika:</strong></div>
                        <div>   ‚úÖ Jami yuvishlar: ${state.history.length}</div>
                        <div>   üéÅ Loyalty ballar: ${state.loyaltyPoints}</div>
                        <div>   ‚ù§Ô∏è Sevimlilar: ${state.favorites.length}</div>
                    </div>
                </div>
            `;

            showMessage('bot', profileHtml);
        }

        // Utility Functions
        function formatPrice(price) {
            return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function saveToStorage() {
            localStorage.setItem('autowash_state', JSON.stringify(state));
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('autowash_state');
            if (saved) {
                const parsed = JSON.parse(saved);
                Object.assign(state, parsed);
            }
        }

        // Initialize on load
        window.onload = init;
    </script>
</body>
</html>
